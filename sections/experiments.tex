\section{Experiments}

\subsection{Datasets}

To our knowledge, there's no existing large scale database of annotated X-ray
single particle images.  Thankfully, we can access and manually label raw
experimental data, specifically amo06516 \cite{liDiffractionDataAerosolized2020},
collected in LCLS through the Coherent X-ray Imaging Data Bank (CXIDB)
\cite{maiaCoherentXrayImaging2012}.  Meanwhile, it's challenging to
automatically scale up annotations for experimental datasets.  We then resort to
skopi \cite{peckSkopiSimulationPackage2021}, a GPU-based program for simulating
diffractive images from noncrystalline biomolecules, for concurrently
synthesizing high-resolution scatter patterns and accurate labels in an
automated manner at scale.  Lastly, we introduce three training modes that
accomodate the need in real-time classification during data collection.  

%% ImageNet
%% \cite{dengImageNetLargescaleHierarchical2009} that provides large scale
%% annotated images, .  

\subsubsection{Experimental datasets}

%% 0                : 83
%% 1                : 296
%% 2                : 177
%% 9                : 52

We chose scattering patterns from five experimental runs (90, 91, 94, 96, 102)
in the raw dataset amo06516 and categorized them into four classes: single hit,
multi hit, unintended hit and background.  It contains 296 single-hit examples,
177 double-hit examples, 83 unitended-hit example and 52 background examples.
There is a variety of variations found in the experimental dataset.  One
prominent reason is that some examples have wrong labels. Even when images are
all correctly labeled, it might still exhibit considerable variations induced by
single particle orientation, X-ray beam properties, detector configuration and
so on.  For example, a user might change detector distance from run to run, and
the scattering pattern could appear to be larger or smaller in response to the
change. Moreover, unexpected causes of variations, such as the presence of dead
pixel areas, have to be addressed on an individual basis.  



\subsubsection{Synthetic datasets}

Given any PDB file, we use skopi \cite{peckSkopiSimulationPackage2021} to
generate annotated SPI images by physically simulating scattered X-rays at a
user-specified conditions like detector distance, photon energy and so on.  We
choose to capture those simulated diffraction patterns using an artificial
simple squared detector since an artificial pnCCD detector takes up much more
storage space.  Our interest is to explore the model generalizability on
\textit{large} single particles, considering the state-of-art resolution ever
reached in an SPI experiment is still at the nanometer level ($>$ 10 $nm$)
{\color{red} (need to fact-check)} unlike in protein crystallography that
studies biological structures at the angstrom level. PDB statistics offers
direct insights on PDB data distribution by molecular weight (\url{https:
//www.rcsb.org/stats/distribution-molecular-weight-structure}).  The
example specimen, PR772 virus particles (PDB: 6Q5U),  in SPI studies, indicating that
particles with molecular weights over 380 $KDa$ can be considered as the
\textit{largest} particles.  {\color{red}(Explain on how datasets are used, more
experiments are undergoing!)} Synthetic datasets are generated by setting the
detector distance at 100.0 $mm$ and photon energy at 1.660 $keV$.  

% Insert the figure HERE and TOP..
\begin{figure}
\centering
\includegraphics[width=1.0\textwidth,keepaspectratio]{example-image}
\caption{PDB data distribution}
\label{fig:pdb_data_distribution}
\end{figure}


\subsubsection{Image mode, mosaic mode and panel mode}

One major constraint in real-time scenario is that we might not have a complete
view of a scattering pattern assembled from pixel areas of individual detector
panels.  We thus consider three different modes in dataset curation: (1) Image
mode, where information from all detector panels is consolidated according to
their respective physical locations; (2) Mosiac mode, where information from
serveral detector panels are combined without acknowleding any geometric
relations among panels;  (3) Panel mode, meaning that only pixel contents in a
single panel during a exposure is visiable to our model.  Image assembly is
trivial in offline applications, but can be complicated in real-time
applications.  Detector readouts from various panels require extra delay to
synchronize and image assembly itself might not be instantaneous, potentially
bottlenecking the FPS (frame per second) during X-ray exposure. Likewise, Mosic
mode allows the use of fewer panels, but is not able to get around the
synchronization issue either.  Conversely, panel mode is currently best suited
for real-time applications, since it doesn't have the constraints of
synchronization delay or image assembly.  One noticable limitation, though, is
that partial information about a scattering pattern on a single panel can
undermine the performance of classification.  On a side note, detectors made of
small panels might not be a good choice for high-speed SPI imaging.  


\subsubsection{Data augmentation for synthetic dataset}

% Random zooming: detect at different detector distances.

Since synthetic datasets are constructed by simulation, there are plenty for
model training on demand.  We find data augmentation still quite valuable in
providing variations caused by changes in detector distance.  For example, it is
expensive to re-simulate scattering patterns using the same particle with the
same conditions but a different detector distance.  Instead, we choose to
randomly zoom in a scattering pattern that is effectively the same as increasing
detector distance.  Zoom-out is technically more difficult to achieve for
missing pixels need to be filled in around the boarders of the original image.
We think zooming-out is not necessarily a scenario we should take into account,
as it will hurt the model performances and should be fixed from the data
collection stage, e.g. users in beamlines can adjust the detector distanecs so
that the diffraction pattern has an adequate size.  


\subsubsection{Performance on experimental data}

xxxx

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{Fast convergence}
\label{fig:fast_convergence}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{Regularization on performance}
\label{fig:regularization_on_performance}
\end{figure}


\begin{figure}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{Confusion matrix (no regularization)}
\label{fig:confusion_matrix_no_reg}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{Confusion matrix (with regularization)}
\label{fig:confusion_matrix_with_reg}
\end{figure}

Nanorice and T4 phage

\subsubsection{Performance on synthetic data}

xxxx

\begin{figure}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{PDB split vs performance}
\label{fig:confusion_matrix_with_reg}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]
{example-image}
\caption{Confusion matrix (10\%)}
\label{fig:confusion_matrix_with_reg}
\end{figure}

